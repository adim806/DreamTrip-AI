name: CI

on:
  push:
    branches: [main, develop, LLM]
  pull_request:
    branches: [main, develop, LLM]

jobs:
  test-client:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "18"
          cache: "npm"
          cache-dependency-path: client/package-lock.json

      - name: Install client dependencies
        working-directory: ./client
        run: npm ci

      - name: Run client unit tests
        working-directory: ./client
        run: npm test

  test-backend:
    runs-on: ubuntu-latest

    services:
      mongodb:
        image: mongo:6
        ports:
          - 27017:27017

    steps:
      - uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "18"
          cache: "npm"
          cache-dependency-path: backend/package-lock.json

      - name: Install backend dependencies
        working-directory: ./backend
        run: npm ci

      - name: Run backend tests
        working-directory: ./backend
        run: npm test
        env:
          MONGODB_URI: mongodb://localhost:27017/test

  e2e-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"
          cache-dependency-path: "client/package-lock.json"

      - name: Create .env file
        working-directory: ./client
        run: |
          cat << 'EOF' > .env
          VITE_CLERK_PUBLISHABLE_KEY=pk_test_ZnVua3ktZ29iYmxlci0zMS5jbGVyay5hY2NvdW50cy5kZXYk
          VITE_IMAGE_KIT_ENDPOINT=https://ik.imagekit.io/ula6wme9r
          VITE_IMAGE_KIT_PUBLIC_KEY=public_FsV5vybnkOY0YhDMsT/8MTXGfDk=
          VITE_GEMINI_PUBLIC_KEY=AIzaSyBJDuXqU-7bSiCfugNpqTThNYOd4AQ6GZ0
          VITE_API_URL=http://localhost:3000
          VITE_GOOGLE_PLACE_API_KEY=AIzaSyABVesZOlB_dAtxjo6COred7Z5PdjojL1k
          VITE_MAPBOX_TOKEN=pk.eyJ1IjoiYWRpbTgwNiIsImEiOiJjbTNrMndrdXowN2IxMnFxejk2eWd3ZHk1In0.CQ3v2jo0DCBsgNgt3raS1g
          VITE_OPENWEATHER_API_KEY=e240b46cf715142953c2d07d2476fa06
          VITE_FOUR_SQUARE_API_KEY=fsq3k6aPMxVzonJJhdAClLku7ueAzXBZkRUKkkGdvNozHO8=
          VITE_SERP_API_KEY=78fc430ff4534992862cc145c105b699cca824ed92a96fd6525a6aa450739fa2
          VITE_GOOGLE_CLOUD_PROJECT_ID=dreamtrip-ai
          VITE_AMADEUS_API_KEY=nZqeWx6AstFzOyjGUGtuQNi76JhVSvjB
          VITE_AMADEUS_API_SECRET=XqfX7Op21zVvDYWs
          EOF

      - name: Install root dependencies
        run: npm ci --force

      - name: Install backend dependencies
        working-directory: ./backend
        run: npm ci --force

      - name: Install client dependencies
        working-directory: ./client
        run: |
          npm ci --force
          npm install --save-dev wait-on --force

      - name: Build application
        working-directory: ./client
        run: npm run build

      - name: Start development server and run tests
        working-directory: ./client
        run: |
          npm run dev &
          sleep 10 
          npm run e2e
